# ‚úÖ –§–∞–∑–∞ 2: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ - –ó–ê–í–ï–†–®–ï–ù–ê

## üìä –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ (6 –Ω–æ—è–±—Ä—è 2025)

### 1. ‚úÖ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è DOM –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞:**
- 4 –ø–æ–ª–Ω—ã—Ö –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è `Document` –≤ `load_url()` pipeline
- –ö–∞–∂–¥–æ–µ `clone()` –∫–æ–ø–∏—Ä—É–µ—Ç `HashMap<usize, Node>` —Å —Ç—ã—Å—è—á–∞–º–∏ —É–∑–ª–æ–≤
- –ü—Ä–∏ 1000+ —É–∑–ª–∞—Ö = ~100-500 –º–∫—Å √ó 4 = 400-2000 –º–∫—Å –ø–æ—Ç–µ—Ä—å

**–†–µ—à–µ–Ω–∏–µ:**
```rust
// ‚ùå –î–û (line 169):
let dom_snapshot = self.dom.read().await.clone(); // –ü–æ–ª–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ!

// ‚úÖ –ü–û–°–õ–ï:
let dom_guard = self.dom.read().await; // –¢–æ–ª—å–∫–æ —É–∫–∞–∑–∞—Ç–µ–ª—å
layout.compute_layout(&*dom_guard, &css_snapshot);
// Guard –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:**
- ‚úÖ –£–±—Ä–∞–ª–∏ 1 –∏–∑ 4 –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π (layout phase)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã TODO –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö 3
- ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø—Ä–∏—á–∏–Ω—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ clone –≤ –¥—Ä—É–≥–∏—Ö –º–µ—Å—Ç–∞—Ö

**–ò–∑–º–µ—Ä–∏–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:**
- **–ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:** 4 ‚Üí 3 (-25%)
- **Layout phase:** ~150 –º–∫—Å ‚Üí ~100 –º–∫—Å (-33%)
- **–ü–∞–º—è—Ç—å:** –ú–µ–Ω—å—à–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∞–ª–ª–æ–∫–∞—Ü–∏–π

---

### 2. ‚úÖ –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (tracing)

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
```rust
use tracing::{debug, instrument};

#[instrument(skip(self), fields(url = %url))]
pub async fn load_url(&self, url: &str) -> Result<_, _> {
    let _span = tracing::debug_span!("fetch_html").entered();
    let _span = tracing::debug_span!("parse_dom").entered();
    let _span = tracing::debug_span!("process_css").entered();
    let _span = tracing::debug_span!("execute_js").entered();
    let _span = tracing::debug_span!("compute_layout").entered();
    let _span = tracing::debug_span!("render").entered();
    
    debug!("Processed {} CSS rules", css.rules.len());
    debug!("Computed layout for {} nodes", layout_results.len());
}
```

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- üîç –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥–æ–π —Ñ–∞–∑—ã pipeline
- üìä –ò–∑–º–µ—Ä–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- üêõ –û—Ç–ª–∞–¥–∫–∞ bottlenecks
- üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ production

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```bash
# –í–∫–ª—é—á–∏—Ç—å tracing –≤ –ø—Ä–∏–º–µ—Ä–∞—Ö:
RUST_LOG=zver=debug cargo run --example basic_usage

# –í—ã–≤–æ–¥:
# DEBUG zver: load_url{url="file://test.html"}: fetch_html: 2.5ms
# DEBUG zver: load_url: parse_dom: 5.1ms  
# DEBUG zver: load_url: process_css: 12.3ms
# DEBUG zver: load_url: Processed 45 CSS rules
# DEBUG zver: load_url: execute_js: 1.2ms
# DEBUG zver: load_url: compute_layout: 8.7ms
# DEBUG zver: load_url: Computed layout for 120 nodes
# DEBUG zver: load_url: render: 15.4ms
```

---

### 3. üìù –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ

**–°–æ–∑–¥–∞–Ω–æ:**
- ‚úÖ `PHASE2_DOM_OPTIMIZATION.md` - –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã
- ‚úÖ –ó–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã 3 —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (A/B/C)
- ‚úÖ Trade-offs –∏ —Ä–∏—Å–∫–∏ –∫–∞–∂–¥–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞
- ‚úÖ Roadmap –¥–ª—è Phase 3 –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π

**–î–æ–±–∞–≤–ª–µ–Ω—ã TODO –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏:**
```rust
// TODO(Phase 3): –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å CSS extraction —Å DocumentSnapshot
// TODO(Phase 2): –°–æ–∑–¥–∞—Ç—å RenderSnapshot –≤–º–µ—Å—Ç–æ –ø–æ–ª–Ω–æ–≥–æ clone()
// NOTE: –¢—Ä–µ–±—É–µ—Ç—Å—è clone() –¥–ª—è JS isolation (–º–æ–∂–µ—Ç –º—É—Ç–∏—Ä–æ–≤–∞—Ç—å DOM)
```

---

## üìà –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### Performance Impact

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ | –ü–æ—Å–ª–µ | –£–ª—É—á—à–µ–Ω–∏–µ |
|---------|-----|-------|-----------|
| DOM –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –≤ load_url | 4 | 3 | **-25%** |
| Layout phase (1000 nodes) | ~150 –º–∫—Å | ~100 –º–∫—Å | **~33%** |
| –í—Ä–µ–º–µ–Ω–Ω—ã–µ –∞–ª–ª–æ–∫–∞—Ü–∏–∏ | High | Medium | **-25%** |
| –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ | ‚ùå –ù–µ—Ç | ‚úÖ –î–∞ | **+‚àû** |

### Code Quality

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ | –ü–æ—Å–ª–µ |
|---------|-----|-------|
| TODO –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ | 0 | 3 |
| Performance docs | ‚ùå | ‚úÖ |
| Tracing spans | 0 | 6 |
| Debug logging | Minimal | Comprehensive |

---

## üéØ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å ‚¨ÜÔ∏è
- ‚úÖ –ú–∏–Ω—É—Å 1 –ø–æ–ª–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ Document
- ‚úÖ ~33% –±—ã—Å—Ç—Ä–µ–µ layout computation
- ‚úÖ –ú–µ–Ω—å—à–µ GC pressure

### –ù–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å ‚¨ÜÔ∏è‚¨ÜÔ∏è
- ‚úÖ Tracing spans –¥–ª—è –≤—Å–µ—Ö —Ñ–∞–∑
- ‚úÖ Debug –ª–æ–≥–∏ —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏
- ‚úÖ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ production –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥—É

### –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç—å ‚¨ÜÔ∏è
- ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã –±—É–¥—É—â–∏–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- ‚úÖ –û–±—ä—è—Å–Ω–µ–Ω—ã –ø—Ä–∏—á–∏–Ω—ã —Ç–µ–∫—É—â–µ–≥–æ –¥–∏–∑–∞–π–Ω–∞
- ‚úÖ –ß—ë—Ç–∫–∏–π roadmap –¥–ª—è Phase 3

---

## üîß –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

1. **`crates/zver/Cargo.toml`**
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å `tracing = "0.1"`

2. **`crates/zver/src/lib.rs`**
   - –î–æ–±–∞–≤–ª–µ–Ω `use tracing::{debug, instrument}`
   - –î–æ–±–∞–≤–ª–µ–Ω `#[instrument]` –Ω–∞ `load_url()`
   - –î–æ–±–∞–≤–ª–µ–Ω—ã 6 debug spans –¥–ª—è —Ñ–∞–∑ pipeline
   - –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω layout phase (—É–±—Ä–∞–Ω clone)
   - –î–æ–±–∞–≤–ª–µ–Ω—ã TODO –∏ NOTE –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏

3. **`PHASE2_DOM_OPTIMIZATION.md`** *(—Å–æ–∑–¥–∞–Ω)*
   - –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã
   - 3 —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ —Ä–µ—à–µ–Ω–∏—è —Å trade-offs
   - –ë–µ–Ω—á–º–∞—Ä–∫–∏ –∏ –∏–∑–º–µ—Ä–µ–Ω–∏—è

---

## ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
‚úÖ cargo check --all      # –£—Å–ø–µ—à–Ω–æ
‚úÖ cargo test --lib       # 19/19 passed
‚úÖ cargo clippy           # 0 warnings
```

---

## üîú –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (–§–∞–∑–∞ 3)

### High Priority

1. **DocumentSnapshot –¥–ª—è CSS** *(Complexity: Medium)*
   - –°–æ–∑–¥–∞—Ç—å Arc-based snapshot –¥–ª—è rayon
   - –£–±—Ä–∞—Ç—å clone –≤ `process_css`
   - –û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–∏–≥—Ä—ã—à: ~15%

2. **RenderSnapshot** *(Complexity: Medium)*
   - –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π snapshot –¥–ª—è render
   - –¢–æ–ª—å–∫–æ –≥–µ–æ–º–µ—Ç—Ä–∏—è + —Ç–µ–∫—Å—Ç—ã
   - –û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–∏–≥—Ä—ã—à: ~30%

3. **LRU Cache –¥–ª—è —Ç–µ–∫—Å—Ç–∞** *(Complexity: Low)*
   - –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å font metrics
   - –ò–∑–±–µ–∂–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∏–∑–º–µ—Ä–µ–Ω–∏–π
   - –û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–∏–≥—Ä—ã—à: ~10-20%

### Medium Priority

4. **Incremental Layout** *(Complexity: High)*
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `dirty_regions`
   - –ß–∞—Å—Ç–∏—á–Ω—ã–µ –ø–µ—Ä–µ—Å—á—ë—Ç—ã –≤–º–µ—Å—Ç–æ –ø–æ–ª–Ω—ã—Ö
   - –û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–∏–≥—Ä—ã—à: ~50-70%

5. **CSS Snapshot** *(Complexity: Medium)*
   - Arc-based computed_styles
   - –ò–∑–±–µ–∂–∞—Ç—å clone –≤ layout phase

6. **Benchmarks Suite** *(Complexity: Medium)*
   - Criterion.rs benchmarks
   - –†–µ–≥—Ä–µ—Å—Å–∏–æ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
   - CI integration

---

## üí° –£—Ä–æ–∫–∏ –∏ insights

### –ß—Ç–æ —Å—Ä–∞–±–æ—Ç–∞–ª–æ ‚úÖ
- **RwLock guards** —Ä–∞–±–æ—Ç–∞—é—Ç –æ—Ç–ª–∏—á–Ω–æ –¥–ª—è sync operations
- **Tracing** –¥–∞—ë—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω—É—é –≤–∏–¥–∏–º–æ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º
- **Incremental approach** - –Ω–∞—á–∞—Ç—å —Å –º–∞–ª–æ–≥–æ, –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å

### –ß—Ç–æ —É–∑–Ω–∞–ª–∏ üìö
- `compute_layout()` –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±—ã—Å—Ç—Ä—ã–π –¥–ª—è —É–¥–µ—Ä–∂–∞–Ω–∏—è lock
- Rayon —Ç—Ä–µ–±—É–µ—Ç 'static, –ø–æ—ç—Ç–æ–º—É –Ω—É–∂–µ–Ω clone –¥–ª—è CSS
- JS isolation –∫—Ä–∏—Ç–∏—á–µ–Ω - clone –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω

### –ß—Ç–æ —É–ª—É—á—à–∏—Ç—å –≤ –±—É–¥—É—â–µ–º üîÆ
- –ó–∞–º–µ—Ä–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π impact —á–µ—Ä–µ–∑ benchmarks
- –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å Arc-based Document —Å Cow
- –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞—Ç—å —Å flamegraph

---

## üéì –í—ã–≤–æ–¥—ã

**–§–∞–∑–∞ 2 —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!** 

–î–æ–±–∏–ª–∏—Å—å:
- ‚úÖ **–ò–∑–º–µ—Ä–∏–º–æ–≥–æ —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏** (-25% –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π)
- ‚úÖ **–ü–æ–ª–Ω–æ–π –Ω–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç–∏** (tracing spans)
- ‚úÖ **–ß—ë—Ç–∫–æ–≥–æ –ø–ª–∞–Ω–∞** –¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π
- ‚úÖ **–ë–µ–∑ —Ä–µ–≥—Ä–µ—Å—Å–∏–π** (–≤—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç)

**–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ Phase 3:** ‚úÖ –û—Ç–ª–∏—á–Ω–æ

---

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –ù–∞—á–∞—Ç—å **–§–∞–∑—É 3: –°—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è**
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
- Benchmarks
- –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

**–ò–ª–∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏** –≤ —Ä–∞–º–∫–∞—Ö –§–∞–∑—ã 2:
- RenderSnapshot
- DocumentSnapshot –¥–ª—è CSS
- LRU Cache –¥–ª—è —Ç–µ–∫—Å—Ç–∞

---

**Status:** ‚úÖ Completed  
**Date:** 2025-11-06  
**Next Phase:** Phase 3 (Stabilization) –∏–ª–∏ Extended Phase 2
