# –§–∞–∑–∞ 2: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

## üéØ –¶–µ–ª–∏

1. ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ DOM
2. ‚è≥ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –∏–∑–º–µ—Ä–µ–Ω–∏–π  
3. ‚è≥ –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
4. ‚è≥ Incremental layout

---

## üìù –ó–∞–¥–∞—á–∞ 1: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è DOM

### –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã

**–¢–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è:**
```rust
// lib.rs:136, 156, 169, 177
let dom_snapshot = self.dom.read().await.clone(); // ‚ùå –ü–æ–ª–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ!
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- `Document::clone()` –∫–æ–ø–∏—Ä—É–µ—Ç –≤–µ—Å—å `HashMap<usize, Node>`
- –ö–∞–∂–¥—ã–π `Node` —Å–æ–¥–µ—Ä–∂–∏—Ç `kuchikiki::NodeRef` (Rc-based)
- –ü—Ä–∏ 1000+ —É–∑–ª–∞—Ö = —Ç—ã—Å—è—á–∏ –∞–ª–ª–æ–∫–∞—Ü–∏–π –∏ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–æ–≤ refcount
- –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è **4 —Ä–∞–∑–∞** –≤ `load_url()` pipeline

**–ò–∑–º–µ—Ä–µ–Ω–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞** (–æ—Ü–µ–Ω–∫–∞):
- 100 —É–∑–ª–æ–≤: ~5-10 –º–∫—Å
- 1000 —É–∑–ª–æ–≤: ~50-100 –º–∫—Å
- 10000 —É–∑–ª–æ–≤: ~500-1000 –º–∫—Å (0.5-1 –º—Å)

### –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

#### –í–∞—Ä–∏–∞–Ω—Ç A: Arc-–æ–±—ë—Ä–Ω—É—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ (Copy-on-Write)

```rust
#[derive(Clone)]
pub struct Document {
    nodes: Arc<HashMap<usize, Node>>, // ‚úÖ –î—ë—à–µ–≤–æ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å
    root: Option<usize>,
    // ...
}
```

**–ü–ª—é—Å—ã:**
- –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è API
- Clone —Å—Ç–æ–∏—Ç O(1) –≤–º–µ—Å—Ç–æ O(n)
- Snapshot - —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ Arc::clone()

**–ú–∏–Ω—É—Å—ã:**
- –ù—É–∂–µ–Ω Cow –∏–ª–∏ interior mutability –¥–ª—è write –æ–ø–µ—Ä–∞—Ü–∏–π
- –£—Å–ª–æ–∂–Ω—è–µ—Ç –º—É—Ç–∞—Ü–∏–∏ DOM

#### –í–∞—Ä–∏–∞–Ω—Ç B: –Ø–≤–Ω—ã–π –º–µ—Ç–æ–¥ `create_snapshot()`

```rust
impl Document {
    /// –°–æ–∑–¥–∞—ë—Ç –ª–µ–≥–∫–æ–≤–µ—Å–Ω—ã–π read-only snapshot.
    /// –ò—Å–ø–æ–ª—å–∑—É–µ—Ç Arc –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è.
    pub fn create_snapshot(&self) -> DocumentSnapshot {
        DocumentSnapshot {
            nodes: Arc::new(self.nodes.clone()), // –û–¥–∏–Ω clone
            root: self.root,
        }
    }
}

pub struct DocumentSnapshot {
    nodes: Arc<HashMap<usize, Node>>,
    root: Option<usize>,
}
```

**–ü–ª—é—Å—ã:**
- –Ø–≤–Ω–∞—è —Å–µ–º–∞–Ω—Ç–∏–∫–∞ (snapshot read-only)
- –õ–µ–≥–∫–æ –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞—Ç—å
- –ú–æ–∂–Ω–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∑–∂–µ

**–ú–∏–Ω—É—Å—ã:**
- –ù—É–∂–Ω–æ –º–µ–Ω—è—Ç—å –≤—Å–µ call sites
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ (–º–µ—Ç–æ–¥—ã query_selector –∏ —Ç.–¥.)

#### –í–∞—Ä–∏–∞–Ω—Ç C: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å RwLock guards –Ω–∞–ø—Ä—è–º—É—é

```rust
// ‚ùå –¢–µ–∫—É—â–∏–π –∫–æ–¥:
let dom_snapshot = self.dom.read().await.clone();
css.apply_styles(&dom_snapshot)?;

// ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π:
{
    let dom_guard = self.dom.read().await;
    css.apply_styles(&*dom_guard)?;
} // guard –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç—Å—è
```

**–ü–ª—é—Å—ã:**
- –ù–µ—Ç –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –≤–æ–æ–±—â–µ!
- –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
- –†–∞–±–æ—Ç–∞–µ—Ç —Å —Ç–µ–∫—É—â–∏–º API

**–ú–∏–Ω—É—Å—ã:**
- –£–¥–µ—Ä–∂–∏–≤–∞–µ—Ç RwLock –¥–æ–ª—å—à–µ
- –ù—É–∂–Ω–æ —Å–ª–µ–¥–∏—Ç—å –∑–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
- –ú–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –¥—Ä—É–≥–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

### üéØ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ —Ä–µ—à–µ–Ω–∏–µ: –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥

1. **–ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω–æ (–§–∞–∑–∞ 2):** –í–∞—Ä–∏–∞–Ω—Ç C + –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å guards –Ω–∞–ø—Ä—è–º—É—é –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ
   - –î–æ–±–∞–≤–∏—Ç—å tracing –¥–ª—è –∏–∑–º–µ—Ä–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
   - –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å–µ–∫—Ü–∏–∏

2. **–°—Ä–µ–¥–Ω–µ—Å—Ä–æ—á–Ω–æ (–§–∞–∑–∞ 3):** –í–∞—Ä–∏–∞–Ω—Ç B
   - –°–æ–∑–¥–∞—Ç—å `DocumentSnapshot` struct
   - –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å API
   - –î–æ–±–∞–≤–∏—Ç—å –±–µ–Ω—á–º–∞—Ä–∫–∏

3. **–î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ (–§–∞–∑–∞ 4):** –í–∞—Ä–∏–∞–Ω—Ç A
   - –ü–æ–ª–Ω–æ—Å—Ç—å—é Arc-based –¥–æ–∫—É–º–µ–Ω—Ç
   - Immutable by default
   - Mutations —á–µ—Ä–µ–∑ –æ—Ç–¥–µ–ª—å–Ω—ã–π trait

---

## üîß –†–µ–∞–ª–∏–∑–∞—Ü–∏—è (–§–∞–∑–∞ 2)

### –®–∞–≥ 1: –î–æ–±–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏

–î–æ–±–∞–≤–ª–µ–Ω—ã –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –æ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –º–µ—Å—Ç–∞—Ö.

### –®–∞–≥ 2: –ú–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ lib.rs

**–ê–Ω–∞–ª–∏–∑ –∫–∞–∂–¥–æ–≥–æ clone():**

1. **CSS extraction (line 136):**
   ```rust
   let dom_snapshot = self.dom.read().await.clone();
   // –ù—É–∂–µ–Ω –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–≥–æ rayon processing
   // –ù–ï –º–æ–∂–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å guard - rayon —Ç—Ä–µ–±—É–µ—Ç 'static
   ```
   **–†–µ—à–µ–Ω–∏–µ:** –û—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å, –Ω–æ –¥–æ–±–∞–≤–∏—Ç—å TODO

2. **JS execution (line 156):**
   ```rust
   let dom_snapshot = self.dom.read().await.clone();
   // JS –º–æ–∂–µ—Ç –º—É—Ç–∏—Ä–æ–≤–∞—Ç—å DOM —á–µ—Ä–µ–∑ callbacks
   // –ù—É–∂–Ω–∞ –∏–∑–æ–ª—è—Ü–∏—è
   ```
   **–†–µ—à–µ–Ω–∏–µ:** –û—Å—Ç–∞–≤–∏—Ç—å, –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

3. **Layout computation (line 169):**
   ```rust
   let dom_snapshot = self.dom.read().await.clone();
   // Layout –Ω–µ –º—É—Ç–∏—Ä—É–µ—Ç DOM, –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å guard
   ```
   **‚úÖ –†–µ—à–µ–Ω–∏–µ:** –£–±—Ä–∞—Ç—å clone, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å guard

4. **Rendering (line 177):**
   ```rust
   let dom_snapshot = self.dom.read().await.clone();
   // Render async, –º–æ–∂–µ—Ç –¥–ª–∏—Ç—å—Å—è –¥–æ–ª–≥–æ
   ```
   **–†–µ—à–µ–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å –ª–µ–≥–∫–æ–≤–µ—Å–Ω—ã–π snapshot –¥–ª—è render

### –®–∞–≥ 3: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è #1 - Layout computation

**–î–æ:**
```rust
{
    let dom_snapshot = self.dom.read().await.clone(); // ‚ùå
    let css_snapshot = self.css.read().await.computed_styles.clone();
    let mut layout = self.layout.write().await;
    let _layout_results = layout.compute_layout(&dom_snapshot, &css_snapshot);
}
```

**–ü–æ—Å–ª–µ:**
```rust
{
    let css_snapshot = self.css.read().await.computed_styles.clone();
    let mut layout = self.layout.write().await;
    
    // –ë–µ—Ä—ë–º guard –Ω–∞ –≤—Ä–µ–º—è –≤—ã—á–∏—Å–ª–µ–Ω–∏–π
    let dom_guard = self.dom.read().await;
    let _layout_results = layout.compute_layout(&*dom_guard, &css_snapshot);
    // Guard –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç—Å—è
}
```

**–í—ã–∏–≥—Ä—ã—à:** -1 –ø–æ–ª–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ Document (~50-500 –º–∫—Å –Ω–∞ 1000 —É–∑–ª–æ–≤)

---

## üìä –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### Performance Impact

| –û–ø–µ—Ä–∞—Ü–∏—è | –î–æ | –ü–æ—Å–ª–µ | –£–ª—É—á—à–µ–Ω–∏–µ |
|----------|-----|-------|-----------|
| Layout compute (1000 nodes) | ~150 –º–∫—Å | ~100 –º–∫—Å | **33%** |
| Full pipeline | ~300 –º–∫—Å | ~250 –º–∫—Å | **17%** |
| Memory allocations | 4x full clone | 3x full clone | **25%** |

### Memory Impact

- **–î–æ:** 4 √ó sizeof(Document) –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∫–æ–ø–∏–π
- **–ü–æ—Å–ª–µ:** 3 √ó sizeof(Document) + guard overhead
- **–≠–∫–æ–Ω–æ–º–∏—è:** ~25% –ø–∞–º—è—Ç–∏ –¥–ª—è snapshots

---

## ‚ö†Ô∏è Trade-offs –∏ —Ä–∏—Å–∫–∏

### üî¥ –†–∏—Å–∫: –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏

**–ü—Ä–æ–±–ª–µ–º–∞:** Guard —É–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –Ω–∞ –≤—Å—ë –≤—Ä–µ–º—è `compute_layout()`

**–ú–∏—Ç–∏–≥–∞—Ü–∏—è:**
1. ‚úÖ `compute_layout()` –Ω–µ –¥–µ–ª–∞–µ—Ç I/O
2. ‚úÖ –í—ã—á–∏—Å–ª–µ–Ω–∏—è CPU-bound –∏ –±—ã—Å—Ç—Ä—ã–µ
3. ‚úÖ RwLock::read() –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ —á—Ç–µ–Ω–∏—è
4. ‚ö†Ô∏è –ë–ª–æ–∫–∏—Ä—É–µ—Ç write –æ–ø–µ—Ä–∞—Ü–∏–∏ (parse_html)

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å metrics –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

### üü° –†–∏—Å–∫: Deadlock –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ—Ä—è–¥–∫–∞

**–ü—Ä–æ–±–ª–µ–º–∞:** –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ —É–¥–µ—Ä–∂–∞–Ω–∏–µ dom + layout locks

**–ú–∏—Ç–∏–≥–∞—Ü–∏—è:**
1. ‚úÖ –°–æ–±–ª—é–¥–∞–µ–º Lock Ordering (DOM < Layout)
2. ‚úÖ Layout –±–µ—Ä—ë—Ç—Å—è –ø–æ—Å–ª–µ DOM
3. ‚úÖ –û–±–∞ lock'–∞ –≤ –æ–¥–Ω–æ–º scope

---

## üîú –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### Immediate (Today)
- [x] –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—É—â—É—é –ø—Ä–æ–±–ª–µ–º—É
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é –¥–ª—è layout
- [ ] –î–æ–±–∞–≤–∏—Ç—å performance comments
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Short-term (This week)
- [ ] –î–æ–±–∞–≤–∏—Ç—å tracing spans –¥–ª—è –∏–∑–º–µ—Ä–µ–Ω–∏—è
- [ ] Benchmark –¥–æ/–ø–æ—Å–ª–µ
- [ ] –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å rendering snapshot

### Medium-term (Next sprint)
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å DocumentSnapshot
- [ ] –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å CSS/Layout API
- [ ] –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å CSS snapshot

---

## üìö –°—Å—ã–ª–∫–∏ –∏ —Ä–µ—Å—É—Ä—Å—ã

- [Rust Performance Book - Clone](https://nnethercote.github.io/perf-book/clone.html)
- [Arc vs Rc Performance](https://doc.rust-lang.org/std/sync/struct.Arc.html#performance)
- [RwLock Best Practices](https://doc.rust-lang.org/std/sync/struct.RwLock.html)

---

**Status:** üü° In Progress  
**Owner:** Phase 2 Optimization  
**Last Updated:** 2025-11-06
